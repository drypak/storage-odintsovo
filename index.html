<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Хранение вещей через ПВЗ</title>
  <style>
    :root{ --bg:#f6f7f9; --card:#fff; --text:#111; --muted:#6b7280; --border:#e5e7eb; --btn:#111; --btnText:#fff; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); background:var(--bg); }
    .wrap{ max-width: 1050px; margin: 34px auto; padding: 0 16px; }
    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    h1{ margin:0 0 8px; font-size: 34px; letter-spacing:-.02em; }
    h2{ margin:0 0 8px; font-size: 20px; }
    p{ margin:0 0 10px; color:var(--muted); line-height:1.4; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 600px){ .row, .row3{ grid-template-columns:1fr; } }

    label{ display:block; font-size: 12px; color: var(--muted); margin: 12px 0 6px; }
    input, select{
      width:100%; padding: 12px 12px;
      border:1px solid var(--border); border-radius: 12px;
      font-size: 14px; outline:none; background:#fff;
    }
    input:focus, select:focus{ border-color:#c7cbd1; box-shadow: 0 0 0 4px rgba(17,17,17,.06); }

    .hint{ font-size:12px; color:var(--muted); margin-top: 6px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:100%; padding: 12px 14px;
      border-radius: 12px; border: 0;
      background: var(--btn); color: var(--btnText);
      font-weight: 700; font-size: 14px; cursor:pointer;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn2{
      display:inline-flex; align-items:center; justify-content:center;
      width:100%; padding: 12px 14px;
      border-radius: 12px; border: 1px solid var(--border);
      background:#fff; color:#111;
      font-weight: 700; font-size: 14px; cursor:pointer;
      margin-top: 10px;
    }

    .pillbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
    .pill{ border:1px solid var(--border); padding: 7px 10px; border-radius: 999px; font-size: 12px; color:#111; background:#fff; }

    .box{ border:1px dashed var(--border); border-radius: 14px; padding: 12px; margin-top: 12px; background:#fafafa; }
    .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .k{ flex: 1 1 160px; border:1px solid var(--border); border-radius: 12px; padding: 12px; background:#fff; }
    .k .t{ font-size: 12px; color: var(--muted); }
    .k .v{ font-size: 18px; font-weight: 800; margin-top:4px; }

    .ok{ color:#0f7a32; font-weight:700; }
    .err{ color:#b42318; font-weight:700; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h1>Оставить вещи в ПВЗ</h1>
        <p>Выберите город и пункт выдачи. Мы посчитаем стоимость и сформируем заказ “ПВЗ → ПВЗ”.</p>

        <div class="pillbar">
          <span class="pill">Оплата: наложенный платёж</span>
          <span class="pill">Надбавка: +5%</span>
          <span class="pill">Вес: до 100 кг</span>
          <span class="pill">Габариты: сумма сторон до 300 см</span>
        </div>

        <label>Город</label>
        <input id="city" list="cityList" placeholder="Начните вводить: Москва, Одинцово, Казань…" autocomplete="off"/>
        <datalist id="cityList"></datalist>
        <div class="hint" id="cityHint">Начните вводить — покажем подсказки из СДЭК.</div>

        <label>ПВЗ (куда сдаёте вещи)</label>
        <input id="pvz" list="pvzList" placeholder="Выберите/введите ПВЗ…" autocomplete="off" disabled/>
        <datalist id="pvzList"></datalist>
        <div class="hint" id="pvzHint">Сначала выберите город.</div>

        <div class="row3">
          <div>
            <label>Телефон</label>
            <input id="phone" placeholder="+7 999 123-45-67"/>
          </div>
          <div>
            <label>Срок (дней)</label>
            <input id="days" type="number" min="1" step="1" placeholder="например, 7"/>
          </div>
          <div>
            <label>Размер</label>
            <select id="size">
              <option value="">Выберите…</option>
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="NEO">Негабарит</option>
            </select>
            <div class="hint">Можно просто S/M/L/XL/Негабарит — без детализации.</div>
          </div>
        </div>

        <div class="kpi">
          <div class="k">
            <div class="t">Стоимость доставки (по калькулятору)</div>
            <div class="v" id="kTariff">—</div>
          </div>
          <div class="k">
            <div class="t">Наложенный платёж (+5%)</div>
            <div class="v" id="kCod">—</div>
          </div>
          <div class="k">
            <div class="t">Статус</div>
            <div class="v" id="kStatus">—</div>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnCalc" disabled>Посчитать стоимость</button>
          <button class="btn" id="btnCreate" disabled>Создать заказ</button>
        </div>

        <button class="btn2" id="btnTg" disabled>Или написать в Telegram</button>

        <div class="box">
          <div id="resultLine" class="hint">Результат появится здесь.</div>
          <div id="debug" class="mono"></div>
        </div>
      </div>

      <div class="card">
        <h2>Как это работает</h2>
        <p>1) Вы выбираете город и ПВЗ.<br/>2) Мы считаем стоимость “ПВЗ → ПВЗ”.<br/>3) Создаём заказ и отдаём трек/uuid.</p>

        <div class="box">
          <div class="hint"><b>Примечания</b></div>
          <p class="hint">• Токены СДЭК хранятся на бэке (Worker), в HTML их нет.<br/>
            • Тестируем сначала на <span class="mono">api.edu.cdek.ru</span>, потом переключаем на прод.<br/>
            • Если калькулятор/заказ требуют дополнительные поля — добавим их в payload (это нормально).</p>
        </div>

        <div class="box">
          <div class="hint"><b>Куда ведёт QR</b></div>
          <p class="hint">На эту страницу. Дальше — выбор города и ПВЗ.</p>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== НАСТРОЙКИ ======
  const API_BASE = "https://YOUR-WORKER.SUBDOMAIN.workers.dev"; // TODO: вставь URL Worker
  const TG_USERNAME = "theiknow"; // TODO: ник без @

  // ====== STATE ======
  let citySelected = null; // { code, city, region, country_code, fias_guid? ... }
  let pvzSelected  = null; // { code, name, address, location? ... }
  let lastTariff   = null; // { tariff_code, tariff_name, delivery_sum, ... }

  const $ = (id) => document.getElementById(id);

  function setStatus(text, kind="") {
    $("kStatus").innerHTML = kind ? `<span class="${kind}">${text}</span>` : text;
  }

  function money(v){
    if (v === null || v === undefined || v === "") return "—";
    const n = Number(v);
    if (!isFinite(n)) return "—";
    return n.toLocaleString("ru-RU") + " ₽";
  }

  function buildTelegramMsg() {
    const phone = $("phone").value.trim();
    const days  = $("days").value.trim();
    const size  = $("size").value;
    const city  = citySelected?.city || $("city").value.trim();
    const pvz   = pvzSelected?.code ? `${pvzSelected.code} — ${pvzSelected.name || ""}` : $("pvz").value.trim();
    const tariff = lastTariff?.delivery_sum ? `Тариф: ${lastTariff.delivery_sum} ₽` : "";
    const cod = lastTariff?.delivery_sum ? `Наложка(+5%): ${(Math.ceil(lastTariff.delivery_sum * 1.05)).toFixed(0)} ₽` : "";

    const msg =
`Здравствуйте! Хочу оставить вещи на хранение.
Город: ${city}
ПВЗ: ${pvz}
Срок: ${days || "—"} дней
Размер: ${size || "—"}
Телефон: ${phone || "—"}
${tariff}
${cod}`;
    return encodeURIComponent(msg);
  }

  function refreshButtons() {
    const okCity = !!citySelected;
    const okPvz  = !!pvzSelected;
    $("pvz").disabled = !okCity;

    $("btnCalc").disabled = !(okCity && okPvz);
    $("btnCreate").disabled = !(okCity && okPvz);
    $("btnTg").disabled = !(okCity && okPvz);
  }

  async function api(path, opts={}) {
    const r = await fetch(API_BASE + path, {
      ...opts,
      headers: { "Content-Type": "application/json", ...(opts.headers || {}) }
    });
    const text = await r.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }
    if (!r.ok) throw new Error(`${r.status}: ${JSON.stringify(data).slice(0,400)}`);
    return data;
  }

  // ====== CITY SUGGEST ======
  let cityTimer = null;
  $("city").addEventListener("input", () => {
    const q = $("city").value.trim();
    citySelected = null;
    pvzSelected = null;
    lastTariff = null;
    $("pvz").value = "";
    $("pvzList").innerHTML = "";
    $("kTariff").textContent = "—";
    $("kCod").textContent = "—";
    setStatus("—");
    refreshButtons();

    clearTimeout(cityTimer);
    if (q.length < 2) {
      $("cityList").innerHTML = "";
      $("cityHint").textContent = "Начните вводить — покажем подсказки из СДЭК.";
      return;
    }
    cityTimer = setTimeout(() => loadCitySuggest(q), 250);
  });

  $("city").addEventListener("change", () => {
    // пользователь мог выбрать из datalist; попробуем сопоставить по data-атрибуту
    const opt = Array.from($("cityList").children).find(o => o.value === $("city").value.trim());
    if (opt && opt.dataset.payload) {
      citySelected = JSON.parse(opt.dataset.payload);
      $("cityHint").innerHTML = `<span class="ok">Выбран город:</span> ${citySelected.city}`;
      loadPVZ(citySelected);
    } else {
      $("cityHint").textContent = "Выберите город из подсказок — так надёжнее.";
    }
    refreshButtons();
  });

  async function loadCitySuggest(q) {
    try{
      $("cityHint").textContent = "Ищем города…";
      const data = await api(`/suggest/cities?q=${encodeURIComponent(q)}`, { method:"GET", headers:{} });
      const list = data?.items || [];
      $("cityList").innerHTML = list.map(x => {
        const label = [x.city, x.region, x.country_code].filter(Boolean).join(", ");
        return `<option value="${escapeHtml(label)}" data-payload='${escapeAttr(JSON.stringify(x))}'></option>`;
      }).join("");
      $("cityHint").textContent = list.length ? "Выберите город из подсказок." : "Ничего не найдено.";
    }catch(e){
      $("cityHint").innerHTML = `<span class="err">Ошибка поиска городов:</span> ${escapeHtml(String(e.message||e))}`;
    }
  }

  // ====== PVZ LIST ======
  $("pvz").addEventListener("change", () => {
    const opt = Array.from($("pvzList").children).find(o => o.value.startsWith($("pvz").value.trim()));
    if (opt && opt.dataset.payload) {
      pvzSelected = JSON.parse(opt.dataset.payload);
      $("pvzHint").innerHTML = `<span class="ok">Выбран ПВЗ:</span> ${pvzSelected.code}`;
    } else {
      $("pvzHint").textContent = "Выберите ПВЗ из списка (код/адрес).";
      pvzSelected = null;
    }
    refreshButtons();
  });

  async function loadPVZ(cityObj) {
    try{
      $("pvzHint").textContent = "Грузим список ПВЗ…";
      $("pvz").disabled = true;
      $("pvzList").innerHTML = "";

      // Берём офисы по городу через Worker
      // city_code / fias_guid зависит от того, что возвращает suggest; Worker это нормализует
      const data = await api(`/deliverypoints?city_code=${encodeURIComponent(cityObj.code||"")}&city=${encodeURIComponent(cityObj.city||"")}`, { method:"GET", headers:{} });
      const items = data?.items || [];
      $("pvzList").innerHTML = items.map(p => {
        const label = `${p.code} — ${p.name || ""} (${p.address || ""})`;
        return `<option value="${escapeHtml(p.code)} — ${escapeHtml(p.address||p.name||"")}" data-payload='${escapeAttr(JSON.stringify(p))}'></option>`;
      }).join("");

      $("pvzHint").textContent = items.length ? "Выберите ПВЗ (код / адрес)." : "ПВЗ не найдены по этому городу.";
      $("pvz").disabled = false;
    }catch(e){
      $("pvzHint").innerHTML = `<span class="err">Ошибка списка ПВЗ:</span> ${escapeHtml(String(e.message||e))}`;
      $("pvz").disabled = false;
    }
  }

  // ====== CALCULATOR ======
  $("btnCalc").addEventListener("click", async () => {
    $("debug").textContent = "";
    setStatus("Считаем…");
    try{
      // Параметры пакета/веса упрощённо — под твою бизнес-логику можешь менять
      // TODO: если нужно, привяжем размер к габаритам/весу более точно
      const pkg = packageBySize($("size").value);

      const payload = {
        city: citySelected,
        pvz: pvzSelected,
        package: pkg,
        // “ПВЗ → тот же ПВЗ”
        from: { type: "pvz", code: pvzSelected.code },
        to:   { type: "pvz", code: pvzSelected.code }
      };

      const data = await api("/calculator", { method:"POST", body: JSON.stringify(payload) });
      lastTariff = data?.tariff || null;

      $("kTariff").textContent = money(lastTariff?.delivery_sum);
      const cod = lastTariff?.delivery_sum ? Math.ceil(Number(lastTariff.delivery_sum) * 1.05) : null;
      $("kCod").textContent = money(cod);

      setStatus("Готово", "ok");
      $("resultLine").innerHTML = `<span class="ok">Стоимость посчитана.</span> Можно создавать заказ.`;
      $("debug").textContent = JSON.stringify(data, null, 2);
    }catch(e){
      setStatus("Ошибка", "err");
      $("resultLine").innerHTML = `<span class="err">Ошибка калькулятора:</span> ${escapeHtml(String(e.message||e))}`;
      $("debug").textContent = String(e.stack||e);
    }
  });

  // ====== CREATE ORDER ======
  $("btnCreate").addEventListener("click", async () => {
    $("debug").textContent = "";
    setStatus("Создаём заказ…");
    try{
      const phone = $("phone").value.trim();
      if (!phone) throw new Error("Введите телефон.");

      if (!lastTariff?.delivery_sum) {
        // на всякий случай посчитаем
        await $("btnCalc").click();
      }

      const pkg = packageBySize($("size").value);
      const days = Number($("days").value || 0);

      const tariffSum = Number(lastTariff?.delivery_sum || 0);
      const codSum = Math.ceil(tariffSum * 1.05);

      const payload = {
        city: citySelected,
        pvz: pvzSelected,
        package: pkg,
        days,
        phone,
        tariff: lastTariff,
        cod_sum: codSum
      };

      const data = await api("/orders", { method:"POST", body: JSON.stringify(payload) });

      setStatus("Создано", "ok");
      $("resultLine").innerHTML =
        `<span class="ok">Заказ создан.</span> UUID: <b>${escapeHtml(data.uuid||"—")}</b> ` +
        (data.track ? `• Трек: <b>${escapeHtml(data.track)}</b>` : "");

      $("debug").textContent = JSON.stringify(data, null, 2);
    }catch(e){
      setStatus("Ошибка", "err");
      $("resultLine").innerHTML = `<span class="err">Ошибка создания:</span> ${escapeHtml(String(e.message||e))}`;
      $("debug").textContent = String(e.stack||e);
    }
  });

  // ====== TELEGRAM FALLBACK ======
  $("btnTg").addEventListener("click", () => {
    const url = `https://t.me/${TG_USERNAME}?text=${buildTelegramMsg()}`;
    window.open(url, "_blank", "noopener");
  });

  // ====== UTILS ======
  function packageBySize(size){
    // TODO:
    const base = { weight: 1.0, length: 30, width: 20, height: 15 };
    if (size === "S") return { weight: 2.0, length: 35, width: 25, height: 20 };
    if (size === "M") return { weight: 10.0, length: 60, width: 40, height: 35 };
    if (size === "L") return { weight: 20.0, length: 80, width: 50, height: 45 };
    if (size === "XL") return { weight: 30.0, length: 100, width: 60, height: 60 };
    if (size === "NEO") return { weight: 50.0, length: 120, width: 80, height: 80 };
    return base;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/'/g, "&#39;"); }

  refreshButtons();
</script>
</body>
</html>
