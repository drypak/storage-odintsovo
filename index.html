<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Оставить вещи в ПВЗ</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111; --muted:#6b7280;
      --border:#e5e7eb; --btn:#111; --btnText:#fff;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); background:var(--bg); }
    .wrap{ max-width: 900px; margin: 34px auto; padding: 0 16px; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius: 18px;
      padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }

    h1{ margin:0 0 8px; font-size: 32px; letter-spacing:-.02em; }
    p{ margin:0 0 10px; color:var(--muted); line-height:1.4; }

    label{ display:block; font-size: 12px; color: var(--muted); margin: 12px 0 6px; }
    input, select{
      width:100%; padding: 12px 12px;
      border:1px solid var(--border); border-radius: 12px;
      font-size: 14px; outline:none; background:#fff;
    }
    input:focus, select:focus{ border-color:#c7cbd1; box-shadow: 0 0 0 4px rgba(17,17,17,.06); }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 650px){ .row{ grid-template-columns:1fr; } }

    .hint{ font-size:12px; color:var(--muted); margin-top: 6px; }
    .hint b{ color:#111; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:100%; padding: 12px 14px;
      border-radius: 12px; border: 0;
      background: var(--btn); color: var(--btnText);
      font-weight: 800; font-size: 14px; cursor:pointer;
      margin-top: 14px;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .btnGhost{
      display:inline-flex; align-items:center; justify-content:center;
      width:100%; padding: 12px 14px;
      border-radius: 12px; border: 1px solid var(--border);
      background:#fff; color:#111;
      font-weight: 800; font-size: 14px; cursor:pointer;
      margin-top: 10px;
    }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin: 10px 0 2px; }
    .chip{ border:1px solid var(--border); padding: 7px 10px; border-radius: 999px; font-size: 12px; background:#fff; }

    .result{
      margin-top: 14px;
      border:1px solid var(--border);
      background:#fafafa;
      border-radius: 14px;
      padding: 12px;
      min-height: 44px;
      font-size: 13px;
      color:#111;
    }
    .ok{ color:#0f7a32; font-weight:800; }
    .err{ color:#b42318; font-weight:800; }

    /* Скрываем "технику" — оставим для дебага, если понадобится */
    .debug{ display:none; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; margin-top: 10px; }

    /* На печать (если вдруг): без лишних полей */
    @media print{
      body{ background:#fff; }
      .wrap{ margin:0; max-width: none; padding:0; }
      .card{ box-shadow:none; border: none; border-radius:0; }
      .btn,.btnGhost,.result,.hint{ display:none !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Оставить вещи в ПВЗ</h1>
      <p>Выберите город и пункт выдачи — дальше мы быстро всё подтвердим в Telegram.</p>

      <div class="chips">
        <span class="chip">до 100 кг</span>
        <span class="chip">габариты до 300 см (сумма сторон)</span>
        <span class="chip">оформление от 200 ₽</span>
      </div>

      <label>Город</label>
      <input id="city" list="cityList" placeholder="Начните вводить: Москва, Одинцово, Казань…" autocomplete="off"/>
      <datalist id="cityList"></datalist>
      <div class="hint" id="cityHint"><b>Подсказка:</b> просто начните вводить — появится список.</div>

      <label>ПВЗ (куда сдаёте вещи)</label>
      <input id="pvz" list="pvzList" placeholder="Выберите ПВЗ из списка…" autocomplete="off" disabled/>
      <datalist id="pvzList"></datalist>
      <div class="hint" id="pvzHint">Сначала выберите город.</div>

      <div class="row">
        <div>
          <label>Телефон для связи</label>
          <input id="phone" placeholder="+7 999 123-45-67"/>
          <div class="hint">На него подтвердим и уточним детали.</div>
        </div>
        <div>
          <label>Размер</label>
          <select id="size">
            <option value="">Выберите…</option>
            <option value="S">S</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
            <option value="NEO">Негабарит</option>
          </select>
          <div class="hint">Можно выбрать примерно — уточним на месте.</div>
        </div>
      </div>

      <button class="btn" id="btnGo" disabled>Написать в Telegram</button>
      <button class="btnGhost" id="btnCalc" disabled>Проверить стоимость (необязательно)</button>

      <div class="result" id="resultLine">Заполните город и ПВЗ — кнопка станет активной.</div>
      <div class="debug" id="debug"></div>
    </div>
  </div>

<script>
  // ====== НАСТРОЙКИ ======
  const API_BASE = "https://YOUR-WORKER.SUBDOMAIN.workers.dev"; // TODO: вставь URL Worker
  const TG_USERNAME = "theiknow"; // TODO: ник без @

  // ====== STATE ======
  let citySelected = null; // { code, city, region, country_code, fias_guid? ... }
  let pvzSelected  = null; // { code, name, address, location? ... }
  let lastTariff   = null; // { delivery_sum, tariff_code, ... }

  const $ = (id) => document.getElementById(id);

  function setResult(html){ $("resultLine").innerHTML = html; }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/'/g, "&#39;"); }

  function isPhoneOk(p){
    const digits = p.replace(/\D/g,'');
    return digits.length >= 10;
  }

  function refreshButtons() {
    const okCity = !!citySelected;
    const okPvz  = !!pvzSelected;
    const phone  = $("phone").value.trim();
    const okPhone = isPhoneOk(phone);
    const okSize = !!$("size").value;

    $("pvz").disabled = !okCity;

    const ready = okCity && okPvz && okPhone && okSize;
    $("btnGo").disabled = !ready;
    $("btnCalc").disabled = !(okCity && okPvz);

    if (!okCity) setResult("Заполните город — появятся подсказки.");
    else if (!okPvz) setResult("Теперь выберите ПВЗ из списка.");
    else if (!okPhone) setResult("Введите телефон — чтобы мы могли подтвердить.");
    else if (!okSize) setResult("Выберите размер — примерно, уточним потом.");
    else setResult(`<span class="ok">Готово.</span> Нажмите “Написать в Telegram” — откроется сообщение с данными.`);
  }

  async function api(path, opts={}) {
    const r = await fetch(API_BASE + path, {
      ...opts,
      headers: { "Content-Type": "application/json", ...(opts.headers || {}) }
    });
    const text = await r.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }
    if (!r.ok) throw new Error(`${r.status}: ${JSON.stringify(data).slice(0,400)}`);
    return data;
  }

  // ====== CITY SUGGEST ======
  let cityTimer = null;
  $("city").addEventListener("input", () => {
    const q = $("city").value.trim();
    citySelected = null;
    pvzSelected = null;
    lastTariff = null;
    $("pvz").value = "";
    $("pvzList").innerHTML = "";
    $("pvzHint").textContent = "Сначала выберите город.";

    clearTimeout(cityTimer);
    if (q.length < 2) {
      $("cityList").innerHTML = "";
      $("cityHint").innerHTML = "<b>Подсказка:</b> просто начните вводить — появится список.";
      refreshButtons();
      return;
    }
    $("cityHint").textContent = "Ищем…";
    cityTimer = setTimeout(() => loadCitySuggest(q), 250);
    refreshButtons();
  });

  $("city").addEventListener("change", () => {
    const opt = Array.from($("cityList").children).find(o => o.value === $("city").value.trim());
    if (opt && opt.dataset.payload) {
      citySelected = JSON.parse(opt.dataset.payload);
      $("cityHint").innerHTML = `<span class="ok">Ок.</span> Теперь выберите ПВЗ.`;
      loadPVZ(citySelected);
    } else {
      $("cityHint").innerHTML = `<span class="err">Выберите город из подсказки</span> — так надёжнее.`;
      citySelected = null;
    }
    refreshButtons();
  });

  async function loadCitySuggest(q) {
    try{
      const data = await api(`/suggest/cities?q=${encodeURIComponent(q)}`, { method:"GET", headers:{} });
      const list = data?.items || [];
      $("cityList").innerHTML = list.map(x => {
        const label = [x.city, x.region].filter(Boolean).join(", ");
        return `<option value="${escapeHtml(label)}" data-payload='${escapeAttr(JSON.stringify(x))}'></option>`;
      }).join("");
      $("cityHint").innerHTML = list.length ? "<b>Подсказка:</b> выберите город из списка." : "Ничего не найдено.";
    }catch(e){
      $("cityHint").innerHTML = `<span class="err">Ошибка:</span> ${escapeHtml(String(e.message||e))}`;
    }
  }

  // ====== PVZ LIST ======
  $("pvz").addEventListener("change", () => {
    const val = $("pvz").value.trim();
    const opt = Array.from($("pvzList").children).find(o => o.value === val);
    if (opt && opt.dataset.payload) {
      pvzSelected = JSON.parse(opt.dataset.payload);
      $("pvzHint").innerHTML = `<span class="ok">ПВЗ выбран.</span>`;
    } else {
      pvzSelected = null;
      $("pvzHint").innerHTML = `<span class="err">Выберите ПВЗ из списка</span> (код/адрес).`;
    }
    refreshButtons();
  });

  async function loadPVZ(cityObj) {
    try{
      $("pvzHint").textContent = "Грузим ПВЗ…";
      $("pvz").disabled = true;
      $("pvzList").innerHTML = "";

      const data = await api(`/deliverypoints?city_code=${encodeURIComponent(cityObj.code||"")}&city=${encodeURIComponent(cityObj.city||"")}`, { method:"GET", headers:{} });
      const items = data?.items || [];

      $("pvzList").innerHTML = items.map(p => {
        const label = `${p.code} — ${p.address || p.name || ""}`;
        return `<option value="${escapeHtml(label)}" data-payload='${escapeAttr(JSON.stringify(p))}'></option>`;
      }).join("");

      $("pvzHint").textContent = items.length ? "Выберите ПВЗ из списка." : "В этом городе ПВЗ не нашли.";
      $("pvz").disabled = false;
    }catch(e){
      $("pvzHint").innerHTML = `<span class="err">Ошибка:</span> ${escapeHtml(String(e.message||e))}`;
      $("pvz").disabled = false;
    } finally {
      refreshButtons();
    }
  }

  // ====== TELEGRAM ======
  function buildTelegramMsg() {
    const phone = $("phone").value.trim();
    const size  = $("size").value;
    const city  = citySelected?.city || $("city").value.trim();
    const pvz   = pvzSelected?.code ? `${pvzSelected.code} — ${pvzSelected.address || pvzSelected.name || ""}` : $("pvz").value.trim();

    // Никаких 5% в тексте. Никаких uuid.
    const msg =
`Здравствуйте! Хочу оставить вещи на хранение.
Город: ${city}
ПВЗ: ${pvz}
Размер: ${size}
Телефон: ${phone}`;
    return encodeURIComponent(msg);
  }

  $("btnGo").addEventListener("click", () => {
    const url = `https://t.me/${TG_USERNAME}?text=${buildTelegramMsg()}`;
    window.open(url, "_blank", "noopener");
  });

  // ====== OPTIONAL: CALCULATOR (скрытый смысл, без вывода “внутрянки”) ======
  $("btnCalc").addEventListener("click", async () => {
    try{
      setResult("Проверяем стоимость…");
      const payload = {
        city: citySelected,
        pvz: pvzSelected,
        package: packageBySize($("size").value || "S"),
        from: { type: "pvz", code: pvzSelected.code },
        to:   { type: "pvz", code: pvzSelected.code }
      };
      const data = await api("/calculator", { method:"POST", body: JSON.stringify(payload) });
      lastTariff = data?.tariff || null;

      // Клиенту показываем просто “от ХХХ ₽”, без деталей и без 5%.
      const sum = Number(lastTariff?.delivery_sum || 0);
      if (sum > 0) setResult(`<span class="ok">Ориентировочно:</span> от <b>${sum.toLocaleString("ru-RU")} ₽</b>. Точную сумму подтвердим в Telegram.`);
      else setResult(`<span class="ok">Готово.</span> Точную сумму подтвердим в Telegram.`);
    }catch(e){
      setResult(`<span class="err">Не получилось посчитать</span>. Ничего страшного — нажмите “Написать в Telegram”, мы всё уточним.`);
    }
  });

  // ====== PHONE/SIZE LIVE ======
  $("phone").addEventListener("input", refreshButtons);
  $("size").addEventListener("change", refreshButtons);

  function packageBySize(size){
    if (size === "S")  return { weight: 2.0, length: 35, width: 25, height: 20 };
    if (size === "M")  return { weight:10.0, length: 60, width: 40, height: 35 };
    if (size === "L")  return { weight:20.0, length: 80, width: 50, height: 45 };
    if (size === "XL") return { weight:30.0, length:100, width: 60, height: 60 };
    if (size === "NEO")return { weight:50.0, length:120, width: 80, height: 80 };
    return { weight: 2.0, length: 35, width: 25, height: 20 };
  }

  refreshButtons();
</script>
</body>
</html>
